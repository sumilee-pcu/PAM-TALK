<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커뮤니티 | PAM-TALK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 헤더 */
        header {
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            flex-shrink: 0;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 2rem;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #27ae60;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            position: relative;
        }

        .nav-links a:hover {
            color: #27ae60;
        }

        .nav-links a.active {
            color: #27ae60;
            font-weight: 600;
        }

        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #27ae60;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            cursor: pointer;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            border: 2px solid white;
            position: relative;
            top: -2px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* 메인 채팅 레이아웃 */
        .chat-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 70px);
            overflow: hidden;
        }

        /* 사이드바 - 채팅룸 목록 */
        .chat-sidebar {
            width: 300px;
            background: #fff;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .sidebar-subtitle {
            font-size: 0.9rem;
            color: #666;
        }

        .room-categories {
            flex: 1;
            overflow-y: auto;
        }

        .category-section {
            margin-bottom: 1rem;
        }

        .category-title {
            padding: 1rem 1.5rem 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .room-list {
            list-style: none;
        }

        .room-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 3px solid transparent;
        }

        .room-item:hover {
            background: #f8f9fa;
        }

        .room-item.active {
            background: #e8f5e8;
            border-left-color: #27ae60;
            font-weight: 600;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .room-icon {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }

        .room-icon.global { background: linear-gradient(45deg, #667eea, #764ba2); }
        .room-icon.local { background: linear-gradient(45deg, #f093fb, #f5576c); }
        .room-icon.group { background: linear-gradient(45deg, #4facfe, #00f2fe); }
        .room-icon.dm { background: linear-gradient(45deg, #43e97b, #38f9d7); }
        .room-icon.announce { background: linear-gradient(45deg, #fa709a, #fee140); }

        .room-details h4 {
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
        }

        .room-details .room-status {
            font-size: 0.8rem;
            color: #666;
        }

        .room-badges {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .unread-badge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .online-count {
            background: #28a745;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* 메인 채팅 영역 */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chat-title h2 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .chat-description {
            font-size: 0.9rem;
            color: #666;
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chat-action-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .chat-action-btn:hover {
            background: #f8f9fa;
            border-color: #27ae60;
        }

        /* 채팅 메시지 영역 */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 70%;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .message.own .message-content {
            align-items: flex-end;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .message.own .message-header {
            flex-direction: row-reverse;
        }

        .message-author {
            font-weight: 600;
            color: #333;
        }

        .message-time {
            color: #888;
        }

        .user-type {
            background: #e9ecef;
            color: #666;
            padding: 0.1rem 0.4rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .user-type.farmer { background: #d4edda; color: #155724; }
        .user-type.consumer { background: #d1ecf1; color: #0c5460; }
        .user-type.restaurant { background: #f8d7da; color: #721c24; }

        .message-bubble {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            position: relative;
            border: 1px solid #e9ecef;
            word-wrap: break-word;
        }

        .message.own .message-bubble {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .eco-message {
            border: 2px solid #28a745;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            position: relative;
        }

        .eco-message::before {
            content: '🌱';
            position: absolute;
            top: -8px;
            right: -8px;
            background: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .eco-points {
            font-weight: bold;
            color: #28a745;
        }

        /* 메시지 입력 영역 */
        .chat-input {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e9ecef;
            background: white;
        }

        .input-container {
            display: flex;
            gap: 0.75rem;
            align-items: end;
        }

        .message-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 0.75rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            resize: none;
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.4;
            transition: border-color 0.2s;
        }

        .message-input:focus {
            outline: none;
            border-color: #27ae60;
        }

        .input-actions {
            display: flex;
            gap: 0.5rem;
        }

        .input-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .emoji-btn {
            background: #f8f9fa;
            color: #666;
        }

        .emoji-btn:hover {
            background: #e9ecef;
        }

        .send-btn {
            background: #27ae60;
            color: white;
        }

        .send-btn:hover {
            background: #2ecc71;
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: #dee2e6;
            cursor: not-allowed;
            transform: none;
        }

        /* 우측 패널 - 온라인 사용자 */
        .users-panel {
            width: 250px;
            background: #fff;
            border-left: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .panel-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .online-users {
            flex: 1;
            overflow-y: auto;
        }

        .user-item {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-item:hover {
            background: #f8f9fa;
        }

        .user-item .user-avatar {
            width: 30px;
            height: 30px;
            font-size: 0.8rem;
        }

        .user-item-info h5 {
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
        }

        .user-item-status {
            font-size: 0.8rem;
            color: #666;
        }

        .typing-indicator {
            padding: 0.75rem 1rem;
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 0.5rem;
            display: none;
        }

        .typing-indicator.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .typing-dots {
            display: inline-flex;
            gap: 2px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #666;
            animation: typingDot 1.5s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.3s; }
        .typing-dot:nth-child(3) { animation-delay: 0.6s; }

        @keyframes typingDot {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .chat-container {
                position: relative;
            }

            .chat-sidebar {
                position: absolute;
                left: -100%;
                z-index: 100;
                height: 100%;
                transition: left 0.3s ease;
            }

            .chat-sidebar.mobile-open {
                left: 0;
            }

            .users-panel {
                display: none;
            }

            .nav-links {
                display: none;
            }

            .mobile-menu-btn {
                display: block;
                background: none;
                border: none;
                font-size: 1.2rem;
                cursor: pointer;
                color: #333;
            }
        }

        .mobile-menu-btn {
            display: none;
        }

        /* 알림 */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* 웰컴 메시지 */
        .welcome-message {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .welcome-message i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <nav>
                <a href="/" class="logo">
                    <i class="fas fa-leaf"></i>
                    PAM-TALK
                </a>

                <ul class="nav-links">
                    <li><a href="/">피드</a></li>
                    <li><a href="/static/marketplace.html">장터</a></li>
                    <li><a href="/static/challenges.html">챌린지</a></li>
                    <li><a href="/static/community.html" class="active">커뮤니티</a></li>
                </ul>

                <div class="user-status">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="user-avatar" title="김농부 (온라인)">
                        김<div class="online-indicator"></div>
                    </div>
                </div>
            </nav>
        </header>

        <div class="chat-container">
            <!-- 사이드바 - 채팅룸 목록 -->
            <div class="chat-sidebar" id="chatSidebar">
                <div class="sidebar-header">
                    <h3 class="sidebar-title">💬 PAM-TALK 커뮤니티</h3>
                    <p class="sidebar-subtitle">농부와 소비자가 함께하는 소통공간</p>
                </div>

                <div class="room-categories">
                    <!-- 글로벌 채팅 -->
                    <div class="category-section">
                        <div class="category-title">🌍 전체 채팅</div>
                        <ul class="room-list">
                            <li class="room-item active" data-room="global" onclick="switchRoom('global')">
                                <div class="room-info">
                                    <div class="room-icon global">
                                        <i class="fas fa-globe"></i>
                                    </div>
                                    <div class="room-details">
                                        <h4>전체 채팅</h4>
                                        <div class="room-status">모든 사용자와 소통</div>
                                    </div>
                                </div>
                                <div class="room-badges">
                                    <div class="online-count">234</div>
                                    <div class="unread-badge">3</div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- 지역 채팅 -->
                    <div class="category-section">
                        <div class="category-title">🗺️ 지역 채팅</div>
                        <ul class="room-list">
                            <li class="room-item" data-room="seoul" onclick="switchRoom('seoul')">
                                <div class="room-info">
                                    <div class="room-icon local">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="room-details">
                                        <h4>서울 지역</h4>
                                        <div class="room-status">서울 농부·소비자 모임</div>
                                    </div>
                                </div>
                                <div class="room-badges">
                                    <div class="online-count">89</div>
                                </div>
                            </li>
                            <li class="room-item" data-room="gyeonggi" onclick="switchRoom('gyeonggi')">
                                <div class="room-info">
                                    <div class="room-icon local">
                                        <i class="fas fa-seedling"></i>
                                    </div>
                                    <div class="room-details">
                                        <h4>경기도 지역</h4>
                                        <div class="room-status">경기 농장 직거래방</div>
                                    </div>
                                </div>
                                <div class="room-badges">
                                    <div class="online-count">156</div>
                                    <div class="unread-badge">1</div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- 그룹 채팅 -->
                    <div class="category-section">
                        <div class="category-title">👥 관심사 그룹</div>
                        <ul class="room-list">
                            <li class="room-item" data-room="organic" onclick="switchRoom('organic')">
                                <div class="room-info">
                                    <div class="room-icon group">
                                        <i class="fas fa-leaf"></i>
                                    </div>
                                    <div class="room-details">
                                        <h4>유기농 애호가</h4>
                                        <div class="room-status">유기농 정보 공유방</div>
                                    </div>
                                </div>
                                <div class="room-badges">
                                    <div class="online-count">67</div>
                                </div>
                            </li>
                            <li class="room-item" data-room="challenges" onclick="switchRoom('challenges')">
                                <div class="room-info">
                                    <div class="room-icon group">
                                        <i class="fas fa-trophy"></i>
                                    </div>
                                    <div class="room-details">
                                        <h4>탄소 챌린지</h4>
                                        <div class="room-status">환경 챌린지 참가자</div>
                                    </div>
                                </div>
                                <div class="room-badges">
                                    <div class="online-count">143</div>
                                    <div class="unread-badge">5</div>
                                </div>
                            </li>
                            <li class="room-item" data-room="recipes" onclick="switchRoom('recipes')">
                                <div class="room-info">
                                    <div class="room-icon group">
                                        <i class="fas fa-utensils"></i>
                                    </div>
                                    <div class="room-details">
                                        <h4>레시피 공유</h4>
                                        <div class="room-status">요리법 & 팁 공유</div>
                                    </div>
                                </div>
                                <div class="room-badges">
                                    <div class="online-count">92</div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- 공지사항 -->
                    <div class="category-section">
                        <div class="category-title">📢 공지사항</div>
                        <ul class="room-list">
                            <li class="room-item" data-room="announcements" onclick="switchRoom('announcements')">
                                <div class="room-info">
                                    <div class="room-icon announce">
                                        <i class="fas fa-bullhorn"></i>
                                    </div>
                                    <div class="room-details">
                                        <h4>플랫폼 공지</h4>
                                        <div class="room-status">중요 알림 및 업데이트</div>
                                    </div>
                                </div>
                                <div class="room-badges">
                                    <div class="unread-badge">2</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 메인 채팅 영역 -->
            <div class="chat-main">
                <div class="chat-header">
                    <div class="chat-title">
                        <div class="room-icon global">
                            <i class="fas fa-globe"></i>
                        </div>
                        <div>
                            <h2 id="currentRoomTitle">전체 채팅</h2>
                            <div class="chat-description" id="currentRoomDesc">모든 PAM-TALK 사용자와 자유롭게 소통하세요</div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn">
                            <i class="fas fa-search"></i> 검색
                        </button>
                        <button class="chat-action-btn">
                            <i class="fas fa-cog"></i> 설정
                        </button>
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <span id="typingUser">김농부님</span>이 입력 중입니다
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- 메시지들이 동적으로 추가됩니다 -->
                    <div class="welcome-message" id="welcomeMessage">
                        <i class="fas fa-comments"></i>
                        <h3>PAM-TALK 커뮤니티에 오신 것을 환영합니다!</h3>
                        <p>농부와 소비자가 함께하는 따뜻한 소통공간입니다.<br>
                        첫 메시지를 보내서 대화에 참여해보세요! 🌱</p>
                    </div>
                </div>

                <div class="chat-input">
                    <div class="input-container">
                        <textarea
                            id="messageInput"
                            class="message-input"
                            placeholder="메시지를 입력하세요..."
                            rows="1"
                            onkeydown="handleInputKeydown(event)"
                            oninput="handleInput()"
                        ></textarea>
                        <div class="input-actions">
                            <button class="input-btn emoji-btn" onclick="toggleEmojiPicker()" title="이모지">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="input-btn send-btn" id="sendButton" onclick="sendMessage()" title="전송" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 우측 패널 - 온라인 사용자 -->
            <div class="users-panel" id="usersPanel">
                <div class="panel-header">
                    <h4 class="panel-title">온라인 사용자</h4>
                    <p style="font-size: 0.8rem; color: #666;">총 <span id="onlineCount">234</span>명</p>
                </div>
                <div class="online-users" id="onlineUsers">
                    <!-- 온라인 사용자 목록이 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentRoom = 'global';
        let currentUser = {
            id: 'user_demo',
            name: '김농부',
            type: 'farmer',
            avatar: '김'
        };
        let messages = {};
        let onlineUsers = [];
        let isTyping = false;
        let typingTimeout;
        let messagePolling;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            initializeChat();
            loadDemoData();
            startMessagePolling();
        });

        // 채팅 초기화
        function initializeChat() {
            // 메시지 입력창 자동 조절
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', (e) => {
                e.target.style.height = 'auto';
                e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
            });

            // 채팅 메시지 영역 스크롤 이벤트
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.addEventListener('scroll', handleChatScroll);
        }

        // 데모 데이터 로드
        function loadDemoData() {
            // 데모 메시지 생성
            messages = {
                'global': [
                    {
                        id: 'msg1',
                        user_id: 'farmer001',
                        username: '박농부',
                        user_type: 'farmer',
                        content: '안녕하세요! 오늘 아침에 수확한 토마토가 정말 맛있게 익었어요 🍅',
                        timestamp: new Date(Date.now() - 300000).toISOString(),
                        eco_points: 5
                    },
                    {
                        id: 'msg2',
                        user_id: 'consumer001',
                        username: '이소비자',
                        user_type: 'consumer',
                        content: '와! 토마토 사진 보니 너무 맛있어보여요. 주문 가능한가요?',
                        timestamp: new Date(Date.now() - 240000).toISOString()
                    },
                    {
                        id: 'msg3',
                        user_id: 'farmer001',
                        username: '박농부',
                        user_type: 'farmer',
                        content: '네! 1kg에 3,500원이에요. 직접 농장에서 가져가시면 500원 할인해드려요!',
                        timestamp: new Date(Date.now() - 180000).toISOString()
                    },
                    {
                        id: 'msg4',
                        user_id: 'restaurant001',
                        username: '맛집사장',
                        user_type: 'restaurant',
                        content: '저희 레스토랑에서도 토마토가 필요한데, 대량 주문 할인이 있나요?',
                        timestamp: new Date(Date.now() - 120000).toISOString()
                    }
                ],
                'seoul': [],
                'gyeonggi': [
                    {
                        id: 'msg5',
                        user_id: 'farmer002',
                        username: '용인농부',
                        user_type: 'farmer',
                        content: '경기도 용인에서 유기농 배추 농사짓고 있습니다! 김장철이라 바쁘네요 😅',
                        timestamp: new Date(Date.now() - 60000).toISOString()
                    }
                ],
                'organic': [],
                'challenges': [
                    {
                        id: 'msg6',
                        user_id: 'eco_warrior',
                        username: '환경지킴이',
                        user_type: 'consumer',
                        content: '로컬푸드 챌린지 15일째! 오늘도 30km 이내 농산물로 장보기 성공! 💪',
                        timestamp: new Date(Date.now() - 30000).toISOString(),
                        eco_points: 10,
                        is_eco_message: true
                    }
                ],
                'recipes': [],
                'announcements': [
                    {
                        id: 'announce1',
                        user_id: 'admin',
                        username: 'PAM-TALK 운영진',
                        user_type: 'admin',
                        content: '🎉 새로운 탄소 챌린지 "제로웨이스트 요리" 가 출시되었습니다! 많은 참여 부탁드려요.',
                        timestamp: new Date(Date.now() - 3600000).toISOString(),
                        is_announcement: true
                    }
                ]
            };

            // 온라인 사용자 생성
            onlineUsers = [
                { id: 'farmer001', name: '박농부', type: 'farmer', avatar: '박', status: '농장에서' },
                { id: 'consumer001', name: '이소비자', type: 'consumer', avatar: '이', status: '장보는 중' },
                { id: 'restaurant001', name: '맛집사장', type: 'restaurant', avatar: '맛', status: '요리 중' },
                { id: 'farmer002', name: '용인농부', type: 'farmer', avatar: '용', status: '수확 중' },
                { id: 'eco_warrior', name: '환경지킴이', type: 'consumer', avatar: '환', status: '챌린지 참여 중' },
                { id: 'organic_lover', name: '유기농러버', type: 'consumer', avatar: '유', status: '온라인' },
            ];

            // UI 업데이트
            renderMessages();
            renderOnlineUsers();
        }

        // 채팅방 전환
        function switchRoom(roomId) {
            // 이전 방 비활성화
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
            });

            // 새 방 활성화
            document.querySelector(`.room-item[data-room="${roomId}"]`).classList.add('active');

            currentRoom = roomId;
            renderMessages();
            updateRoomHeader();

            // 읽지 않은 메시지 배지 제거
            const unreadBadge = document.querySelector(`.room-item[data-room="${roomId}"] .unread-badge`);
            if (unreadBadge) {
                unreadBadge.remove();
            }

            // 모바일에서 사이드바 닫기
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // 채팅방 헤더 업데이트
        function updateRoomHeader() {
            const roomInfo = {
                'global': { title: '전체 채팅', desc: '모든 PAM-TALK 사용자와 자유롭게 소통하세요', icon: 'fas fa-globe' },
                'seoul': { title: '서울 지역', desc: '서울 농부·소비자 모임', icon: 'fas fa-map-marker-alt' },
                'gyeonggi': { title: '경기도 지역', desc: '경기 농장 직거래방', icon: 'fas fa-seedling' },
                'organic': { title: '유기농 애호가', desc: '유기농 정보 공유방', icon: 'fas fa-leaf' },
                'challenges': { title: '탄소 챌린지', desc: '환경 챌린지 참가자들의 소통공간', icon: 'fas fa-trophy' },
                'recipes': { title: '레시피 공유', desc: '맛있는 요리법과 팁을 나누어요', icon: 'fas fa-utensils' },
                'announcements': { title: '플랫폼 공지', desc: '중요 알림 및 업데이트', icon: 'fas fa-bullhorn' }
            };

            const info = roomInfo[currentRoom];
            document.getElementById('currentRoomTitle').textContent = info.title;
            document.getElementById('currentRoomDesc').textContent = info.desc;

            const roomIcon = document.querySelector('.chat-header .room-icon i');
            roomIcon.className = info.icon;
        }

        // 메시지 렌더링
        function renderMessages() {
            const chatMessages = document.getElementById('chatMessages');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const roomMessages = messages[currentRoom] || [];

            if (roomMessages.length === 0) {
                welcomeMessage.style.display = 'block';
                return;
            } else {
                welcomeMessage.style.display = 'none';
            }

            chatMessages.innerHTML = '';

            roomMessages.forEach(message => {
                const messageElement = createMessageElement(message);
                chatMessages.appendChild(messageElement);
            });

            // 스크롤을 최하단으로
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 메시지 요소 생성
        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.user_id === currentUser.id ? 'own' : ''}`;

            const isEcoMessage = message.is_eco_message || message.eco_points > 0;
            const isAnnouncement = message.is_announcement;

            const userTypeClass = message.user_type || 'consumer';
            const userTypeLabel = {
                'farmer': '🌾 농부',
                'consumer': '🏠 소비자',
                'restaurant': '🍽️ 레스토랑',
                'admin': '⚡ 운영진'
            }[userTypeClass] || '👤 사용자';

            messageDiv.innerHTML = `
                <div class="message-avatar">${message.username ? message.username.charAt(0) : 'U'}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${message.username}</span>
                        <span class="user-type ${userTypeClass}">${userTypeLabel}</span>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                    <div class="message-bubble ${isEcoMessage ? 'eco-message' : ''} ${isAnnouncement ? 'announcement' : ''}">
                        ${message.content}
                        ${message.eco_points ? `<div class="eco-points">+${message.eco_points} 에코포인트 획득!</div>` : ''}
                    </div>
                </div>
            `;

            return messageDiv;
        }

        // 온라인 사용자 렌더링
        function renderOnlineUsers() {
            const onlineUsersContainer = document.getElementById('onlineUsers');
            const onlineCount = document.getElementById('onlineCount');

            onlineCount.textContent = onlineUsers.length + 1; // +1 for current user

            onlineUsersContainer.innerHTML = onlineUsers.map(user => `
                <div class="user-item" onclick="startDirectMessage('${user.id}')">
                    <div class="user-avatar">${user.avatar}</div>
                    <div class="user-item-info">
                        <h5>${user.name}</h5>
                        <div class="user-item-status">${user.status}</div>
                    </div>
                </div>
            `).join('');
        }

        // 메시지 전송
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();

            if (!content) return;

            const newMessage = {
                id: 'msg_' + Date.now(),
                user_id: currentUser.id,
                username: currentUser.name,
                user_type: currentUser.type,
                content: content,
                timestamp: new Date().toISOString()
            };

            // 에코 키워드 감지
            const ecoKeywords = ['챌린지', '환경', '탄소', '에코', '친환경', '유기농', '로컬'];
            if (ecoKeywords.some(keyword => content.includes(keyword))) {
                newMessage.eco_points = 5;
                newMessage.is_eco_message = true;
            }

            // 메시지 추가
            if (!messages[currentRoom]) {
                messages[currentRoom] = [];
            }
            messages[currentRoom].push(newMessage);

            // UI 업데이트
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = createMessageElement(newMessage);
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // 입력창 초기화
            messageInput.value = '';
            messageInput.style.height = 'auto';
            document.getElementById('sendButton').disabled = true;

            // 에코 포인트 알림
            if (newMessage.eco_points) {
                showNotification(`환경 관련 메시지로 +${newMessage.eco_points} 에코포인트 획득! 🌱`);
            }

            // 웰컴 메시지 숨기기
            document.getElementById('welcomeMessage').style.display = 'none';
        }

        // 입력 처리
        function handleInput() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            sendButton.disabled = !messageInput.value.trim();

            // 타이핑 표시
            if (!isTyping) {
                isTyping = true;
                showTypingIndicator();
            }

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                hideTypingIndicator();
            }, 1000);
        }

        // 키보드 이벤트 처리
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // 타이핑 표시
        function showTypingIndicator() {
            // 데모용 - 실제로는 다른 사용자의 타이핑을 표시
            if (Math.random() > 0.7) {
                const indicator = document.getElementById('typingIndicator');
                const randomUser = onlineUsers[Math.floor(Math.random() * onlineUsers.length)];
                document.getElementById('typingUser').textContent = randomUser.name + '님';
                indicator.classList.add('show');

                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('show');
        }

        // 메시지 폴링 시작
        function startMessagePolling() {
            // 실제 구현에서는 서버에서 새 메시지를 가져옴
            messagePolling = setInterval(() => {
                // 데모: 랜덤하게 새 메시지 생성
                if (Math.random() > 0.95) {
                    generateRandomMessage();
                }
            }, 3000);
        }

        // 랜덤 메시지 생성 (데모용)
        function generateRandomMessage() {
            const rooms = ['global', 'gyeonggi', 'challenges'];
            const randomRoom = rooms[Math.floor(Math.random() * rooms.length)];
            const randomUser = onlineUsers[Math.floor(Math.random() * onlineUsers.length)];

            const demoMessages = [
                '오늘 날씨가 정말 좋네요! 농장 일하기 딱 좋은 날이에요 ☀️',
                '방금 배송받은 토마토 정말 신선하네요! 감사합니다 🍅',
                '이번 주 로컬푸드 챌린지 성공! 탄소발자국 -5kg 달성했어요!',
                '유기농 당근 정말 달아요! 아이들이 너무 좋아해요 🥕',
                '농장 체험 프로그램 언제 시작하나요?',
                '제철 음식 레시피 공유해주세요!',
                '친환경 포장재 사용해주셔서 감사해요 ♻️'
            ];

            const newMessage = {
                id: 'msg_' + Date.now() + '_auto',
                user_id: randomUser.id,
                username: randomUser.name,
                user_type: randomUser.type,
                content: demoMessages[Math.floor(Math.random() * demoMessages.length)],
                timestamp: new Date().toISOString()
            };

            // 에코 메시지 확률
            if (Math.random() > 0.7) {
                newMessage.eco_points = Math.floor(Math.random() * 10) + 1;
                newMessage.is_eco_message = true;
            }

            if (!messages[randomRoom]) {
                messages[randomRoom] = [];
            }
            messages[randomRoom].push(newMessage);

            // 현재 방이면 UI 업데이트
            if (randomRoom === currentRoom) {
                const chatMessages = document.getElementById('chatMessages');
                const messageElement = createMessageElement(newMessage);
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // 웰컴 메시지 숨기기
                document.getElementById('welcomeMessage').style.display = 'none';
            } else {
                // 다른 방에 읽지 않은 메시지 배지 추가
                const roomItem = document.querySelector(`.room-item[data-room="${randomRoom}"]`);
                if (roomItem) {
                    let unreadBadge = roomItem.querySelector('.unread-badge');
                    if (!unreadBadge) {
                        unreadBadge = document.createElement('div');
                        unreadBadge.className = 'unread-badge';
                        unreadBadge.textContent = '1';
                        roomItem.querySelector('.room-badges').appendChild(unreadBadge);
                    } else {
                        unreadBadge.textContent = parseInt(unreadBadge.textContent) + 1;
                    }
                }
            }
        }

        // 직접 메시지 시작
        function startDirectMessage(userId) {
            const user = onlineUsers.find(u => u.id === userId);
            if (user) {
                alert(`${user.name}님과의 1:1 채팅을 시작합니다!

1:1 채팅 기능은 개발 중입니다. 🚧`);
            }
        }

        // 이모지 피커 토글
        function toggleEmojiPicker() {
            const commonEmojis = ['😊', '👍', '❤️', '😂', '🎉', '👏', '🙏', '💪', '🌱', '🍅', '🥕', '🌽', '🍎', '🌾', '♻️'];
            const emoji = commonEmojis[Math.floor(Math.random() * commonEmojis.length)];

            const messageInput = document.getElementById('messageInput');
            messageInput.value += emoji;
            handleInput();
            messageInput.focus();
        }

        // 채팅 스크롤 처리
        function handleChatScroll() {
            // 스크롤 최상단 도달 시 이전 메시지 로드 (실제 구현에서)
        }

        // 모바일 사이드바 토글
        function toggleSidebar() {
            const sidebar = document.getElementById('chatSidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // 시간 포맷팅
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return '방금 전';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}분 전`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}시간 전`;
            return date.toLocaleDateString('ko-KR');
        }

        // 알림 표시
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 페이지 언로드 시 폴링 정리
        window.addEventListener('beforeunload', () => {
            if (messagePolling) {
                clearInterval(messagePolling);
            }
        });
    </script>
</body>
</html>